pipeline {
    agent any

    environment {
        APP_NAME = 'vitta-app'
        IMAGE_TAG = "${APP_NAME}:${BUILD_ID}"
    }

    stages {
        stage('Verificar Repositório') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], useRemoteConfigs: [[url: 'https://github.com/oj0rel/Vitta_GerenciamentoDeMedicamentos_Backend']]])
            }
        }

        // REMOVI o stage de "Instalar Dependências" (Maven)
        // Motivo: Seu Dockerfile já faz o build do Maven na etapa 1. Fazer aqui seria trabalho duplicado.

        stage('Construir Imagem Full Stack') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'expo-token-secret', variable: 'ENV_EXPO_TOKEN')]) {
                        
                        echo "Iniciando build do Backend (Java) e Frontend (APK) via Docker..."
                        
                        // O comando é executado na RAIZ (.)
                        // Passamos o token para o Dockerfile usar no estágio do mobile
                        sh "docker build --build-arg EXPO_TOKEN=${ENV_EXPO_TOKEN} -t ${env.IMAGE_TAG} ."
                    }
                }
            }
        }

        stage('Deploy / Rodar') {
            steps {
                script {
                    sh "docker stop ${env.APP_NAME} || true"
                    sh "docker rm -v ${env.APP_NAME} || true"

                    // Roda a imagem final que tem o JAR rodando e o APK salvo na pasta /app/apk
                    sh "docker run -d --name ${env.APP_NAME} -p 8407:8407 ${env.IMAGE_TAG}"
                }
            }
        }
    }
    
    post {
        success {
            echo 'Build completo! Backend rodando e APK gerado dentro do container.'
        }
        failure {
            echo 'Falha no build.'
        }
    }
}